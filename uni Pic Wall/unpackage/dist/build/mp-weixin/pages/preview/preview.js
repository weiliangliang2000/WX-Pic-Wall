"use strict";const e=require("../../common/vendor.js"),o=require("../../utils/system.js"),a=require("../../utils/request.js");if(!Array){(e.resolveComponent("uni-icons")+e.resolveComponent("uni-dateformat")+e.resolveComponent("uni-popup"))()}Math||((()=>"../../uni_modules/uni-icons/components/uni-icons/uni-icons.js")+(()=>"../../uni_modules/uni-dateformat/components/uni-dateformat/uni-dateformat.js")+(()=>"../../uni_modules/uni-popup/components/uni-popup/uni-popup.js"))();const n={__name:"preview",setup(n){const l=e.ref(!0),t=e.ref([]),s=e.ref(""),u=e.ref(["","自然","建筑","美女","AI","动漫","萌宠","运动","帅哥","其他"]),i=e.index.getStorageSync("pic")||[];console.log("hotstorage:",i),t.value=i;const c=e.ref([]),r=e.ref(""),d=e.ref(0),v=e.ref([]);function p(e){d.value=e.detail.current,v.value.push(d.value<=0?t.value.length-1:d.value-1,d.value,d.value>=t.value.length-1?0:d.value+1),c.value=t.value[d.value],v.value=[...new Set(v.value)],console.log("当前图片id：",c.value.id)}e.onLoad((async e=>{console.log(e),r.value=e.id,d.value=t.value.findIndex((e=>e.id==r.value)),v.value.push(d.value<=0?t.value.length-1:d.value-1,d.value,d.value>=t.value.length-1?0:d.value+1),console.log("匹配的索引：",d.value+1),c.value=t.value[d.value]}));const g=()=>{s.value.open()};function f(){s.value.close()}const m=()=>{!async function(){try{e.index.showLoading({title:"下载中",mask:!0}),e.index.getImageInfo({src:c.value.image_url,success:o=>{const n=o.path;console.log("获取到的图片路径:",n),n?e.index.saveImageToPhotosAlbum({filePath:n,success:o=>{console.log("保存到相册成功",o),e.index.showToast({title:"下载成功",icon:"none",duration:1500}),e.index.request({url:a.url+"wallpapers",method:"POST",data:{id:c.value.id},success:e=>{200===e.statusCode?console.log("Download count updated successfully:",e.data.downloads):console.error("Failed to update download count:",e.data.message)},fail:e=>{console.error("API request failed:",e)}})},fail:o=>{console.error("保存到相册失败",o),"saveImageToPhotosAlbum:fail cancel"!=o.errMsg?e.index.showModal({title:"提示",content:"需要授权保存相册",success:o=>{o.confirm&&e.index.openSetting({success(o){o.authSetting["scope.writePhotosAlbum"]?e.index.showToast({title:"获取授权成功",icon:"none"}):e.index.showToast({title:"获取授权失败",icon:"none"})}})}}):e.index.showToast({title:"保存失败，请点击重新下载",icon:"none"})},complete:()=>{e.index.hideLoading()}}):console.error("获取的图片路径为空")},fail:e=>{console.error("获取图片信息失败",e)}})}catch(o){e.index.hideLoading(),console.log(o)}}()};e.onShareAppMessage((e=>({title:"Pic-Wall",path:"/pages/preview/preview?id="+r.value+"&type=share"}))),e.onShareTimeline((()=>({title:"Pic-Wall",path:"/pages/index/index",query:"id="+r.value+"&type=share"})));const h=()=>{l.value=!l.value},x=()=>{e.index.navigateBack()};return e.onUnload((()=>{console.log("onUnload triggered"),e.index.removeStorageSync("pic")})),(a,n)=>e.e({a:e.f(t.value,((o,a,n)=>e.e({a:v.value.includes(a)},v.value.includes(a)?{b:e.o(h,o.id),c:o.image_url}:{},{d:o.id}))),b:e.o(p),c:d.value,d:l.value},l.value?{e:e.p({type:"back",color:"#fff",size:"20"}),f:e.o(x),g:e.unref(o.getStatusBarHeight)()+"px",h:e.unref(o.getTitleBarHeight)()+"px",i:e.t(d.value+1),j:e.t(t.value.length),k:e.p({date:new Date,format:"hh:mm"}),l:e.p({date:new Date,format:"MM月dd日"}),m:e.p({type:"info",size:"28"}),n:e.o(g),o:e.p({type:"download",size:"23"}),p:e.o(m)}:{},{q:e.p({type:"closeempty",size:"18",color:"#999"}),r:e.o(f),s:e.t(c.value.id),t:e.t(u.value[c.value.category_id]),v:e.t(c.value.description),w:e.t(c.value.downloads),x:e.sr(s,"cf2db6cb-5",{k:"infopopup"}),y:e.p({type:"bottom"})})}},l=e._export_sfc(n,[["__scopeId","data-v-cf2db6cb"]]);n.__runtimeHooks=6,wx.createPage(l);
